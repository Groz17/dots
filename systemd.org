* Mail
** Sync
*** Service
#+begin_src conf :tangle ~/.config/systemd/user/mail-sync.service
[Unit]
Description=Mail Sync Service
Documentation=https://man.sr.ht/~rjarry/aerc/integrations/notmuch.md
After=network-online.target

[Service]
Type=oneshot
ExecStart=%h/.config/notmuch/%p.sh
#+end_src

*** Script
#+begin_src sh :tangle ~/.config/notmuch/mail-sync.sh :shebang "#!/bin/sh"
MBSYNC=$(pgrep mbsync)
NOTMUCH=$(pgrep notmuch)

if [ -n "$MBSYNC" -o -n "$NOTMUCH" ]; then
    echo "Already running one instance of mbsync or notmuch. Exiting..."
    exit 0
fi

notmuch search --format=text0 --output=files tag:deleted > /tmp/tagged_as_deleted
emails_to_deleted=$(awk -v RS='\0' 'END{print NR}' < /tmp/tagged_as_deleted)
if [ $emails_to_deleted -gt 0 ]; then
    zenity --question --title="Email deletion" --text="Delete $emails_to_deleted Emails?" &&
    xargs -0 -a /tmp/tagged_as_deleted rm -v &&
    dunstify -u critical "Email update" "Deleted $emails_to_deleted Email(s)"
fi

mbsync -Va &&
notmuch new
#+end_src

*** Timer
#+begin_src conf :tangle ~/.config/systemd/user/mail-sync.timer
[Unit]
Description=Mail Sync Timer

[Timer]
OnActiveSec=1us
OnUnitInactiveSec=2m
#+end_src

** Oauth2
*** Service
#+begin_src conf :tangle ~/.config/systemd/user/pizauth.service :noweb yes
[Unit]
Description=Pizauth OAuth2 token manager

[Service]
Type=simple
ExecStart=/usr<<PATH()>>bin/pizauth server -vvvv -d
ExecReload=/usr<<PATH()>>bin/pizauth reload
ExecStop=/usr<<PATH()>>bin/pizauth shutdown

[Install]
WantedBy=default.target
#+end_src

#+name: PATH
#+begin_src bash :tangle no :noweb yes
[[ <<chassis()>> = "desktop" ]] && echo '/local/' || echo '/'
#+end_src

* Archive
** Service
#+begin_src conf :tangle ~/.config/systemd/user/archive.service
[Unit]
Description=Archive temporary files
ConditionPathIsDirectory=%h/tmp
ConditionPathIsDirectory=%h/tmp/.archive

[Service]
Type=oneshot
ExecStart=/usr/bin/find %h/tmp -mindepth 1 -maxdepth 1 -path %h/tmp/.archive -prune -o -exec mv -t %h/tmp/.archive {} +
#+end_src

** Timer
#+begin_src conf :tangle ~/.config/systemd/user/archive.timer
[Unit]
Description=Archive temporary files daily

[Timer]
OnCalendar=daily
Persistent=true

[Install]
WantedBy=timers.target
#+end_src

* Theme
** Light
*** Service
#+begin_src conf :tangle ~/.config/systemd/user/theme-light.service
[Unit]
Description=Switch to light theme

[Service]
Type=oneshot
ExecStart=/usr/bin/gsettings set org.gnome.desktop.interface color-scheme 'prefer-light'
#+end_src

*** Timer
#+begin_src conf :tangle ~/.config/systemd/user/theme-light.timer
[Unit]
Description=Switch to light theme at sunrise

[Timer]
OnCalendar=*-*-* 07:30:00
Persistent=true

[Install]
WantedBy=timers.target
#+end_src

** Dark
*** Service
#+begin_src conf :tangle ~/.config/systemd/user/theme-dark.service
[Unit]
Description=Switch to dark theme

[Service]
Type=oneshot
ExecStart=/usr/bin/gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark'
#+end_src

*** Timer
#+begin_src conf :tangle ~/.config/systemd/user/theme-dark.timer
[Unit]
Description=Switch to dark theme at sunset

[Timer]
OnCalendar=*-*-* 21:00:00
Persistent=true

[Install]
WantedBy=timers.target
#+end_src

* Kanata
** Service
#+begin_src conf :tangle ~/.config/systemd/user/kanata.service
[Unit]
Description=Kanata keyboard remapper
Documentation=https://github.com/jtroo/kanata

[Service]
Environment=PATH=/usr/local/bin:/usr/local/sbin:/usr/bin:/bin
#   Uncomment the 4 lines beneath this to increase process priority
#   of Kanata in case you encounter lagginess when resource constrained.
#   WARNING: doing so will require the service to run as an elevated user such as root.
#   Implementing least privilege access is an exercise left to the reader.
#
# CPUSchedulingPolicy=rr
# CPUSchedulingPriority=99
# IOSchedulingClass=realtime
# Nice=-20
Type=simple
ExecStart=/usr/bin/sh -c 'exec $$(which kanata) --cfg $${HOME}/.config/kanata/config.kbd'
Restart=no

[Install]
WantedBy=default.target
#+end_src

* Monitoring
** Waybar
*** Path
#+begin_src conf :tangle ~/.config/systemd/user/waybar.path
[Unit]
Description=Watch waybar config files

[Path]
PathChanged=%h/.config/waybar/config.jsonc
PathChanged=%h/.config/waybar/style.css

[Install]
WantedBy=default.target
#+end_src

*** Service
#+begin_src conf :tangle ~/.config/systemd/user/waybar.service
[Unit]
Description=Reload waybar

[Service]
Type=oneshot
ExecStart=/usr/bin/pkill -SIGUSR2 waybar
#+end_src

** Ghostty
*** Path
#+begin_src conf :tangle ~/.config/systemd/user/ghostty.path
[Unit]
Description=Watch ghostty config file

[Path]
PathChanged=%h/.config/ghostty/config

[Install]
WantedBy=default.target
#+end_src

*** Service
#+begin_src conf :tangle ~/.config/systemd/user/ghostty.service
[Unit]
Description=Reload ghostty

[Service]
Type=oneshot
ExecStartPre=/bin/sh -c "/usr/bin/hyprctl activewindow -j | jq -e 'select(.initialClass==\"com.mitchellh.ghostty\")'"
ExecStartPre=/usr/bin/ghostty +validate-config
ExecStart=/usr/bin/wtype -M alt -M win r
#+end_src

** Kanata
*** Path
#+begin_src conf :tangle ~/.config/systemd/user/monitor_kanata.path
[Unit]
Description=Watch kanata config file

[Path]
PathChanged=%h/.config/kanata/config.kbd

[Install]
WantedBy=default.target
#+end_src

*** Service
#+begin_src conf :tangle ~/.config/systemd/user/monitor_kanata.service :noweb yes
[Unit]
Description=Reload kanata

[Service]
Type=oneshot
ExecStartPre=/usr/bin/sh -c '$$(which kanata) --check --cfg $${HOME}/.config/kanata/config.kbd || { dunstify -a Kanata "Config Validation" "Syntax error"; exit 1; }'
ExecStart=/usr/bin/systemctl --user restart kanata
#+end_src
